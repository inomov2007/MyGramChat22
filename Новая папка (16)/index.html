<!DOCTYPE html>
<html lang="tg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Instagram Master App</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --blue: #0095f6; --bg: #fafafa; --border: #dbdbdb; --red: #ed4956; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, sans-serif; }
        body { background: var(--bg); display: flex; justify-content: center; }
        .hidden { display: none !important; }

        .app-container { width: 100%; max-width: 450px; height: 100vh; background: white; border: 1px solid var(--border); position: relative; display: flex; flex-direction: column; overflow: hidden; }
        header { height: 60px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; padding: 0 15px; background: white; flex-shrink: 0; }
        .logo { font-size: 24px; font-weight: bold; font-style: italic; }

        .page { display: none; flex-direction: column; height: calc(100% - 110px); overflow-y: auto; background: white; }
        .active-page { display: flex; }

        /* POSTS */
        .post { border-bottom: 1px solid var(--border); margin-bottom: 10px; padding-bottom: 10px; }
        .post-header { padding: 10px; display: flex; align-items: center; gap: 10px; font-weight: 600; }
        .avatar-sm { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; background: #eee; }
        .post-img { width: 100%; aspect-ratio: 1/1; object-fit: cover; }
        .post-btns { padding: 10px; display: flex; gap: 15px; font-size: 22px; }

        /* SEARCH & CHAT */
        .search-bar { padding: 10px; position: sticky; top: 0; background: white; border-bottom: 1px solid #eee; }
        .user-row { padding: 10px 15px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #f9f9f9; }
        .msg-box { flex: 1; padding: 15px; display: flex; flex-direction: column; gap: 10px; overflow-y: auto; background: #f0f2f5; }
        .msg { max-width: 75%; padding: 8px 12px; border-radius: 18px; font-size: 14px; }
        .sent { align-self: flex-end; background: var(--blue); color: white; }
        .rec { align-self: flex-start; background: white; }

        /* INPUTS */
        .auth-input { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid var(--border); border-radius: 8px; outline: none; background: #fafafa; }
        .btn-blue { width: 100%; padding: 10px; background: var(--blue); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        
        .nav-bottom { height: 50px; border-top: 1px solid var(--border); display: flex; justify-content: space-around; align-items: center; background: white; }
        .nav-bottom i { font-size: 24px; cursor: pointer; }

        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; }
        .modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; width: 85%; border-radius: 12px; padding: 20px; z-index: 1001; }
    </style>
</head>
<body>

<div id="authPage" style="height:100vh; display:flex; align-items:center; justify-content:center; width:100%;">
    <div style="width:320px; text-align:center; padding:20px; border:1px solid #dbdbdb; background:white;">
        <h1 class="logo" style="margin-bottom:30px;">Instagram</h1>
        <input type="text" id="email" class="auth-input" placeholder="Email">
        <input type="password" id="password" class="auth-input" placeholder="Парол">
        <button class="btn-blue" onclick="handleAuth()">Ворид шудан</button>
        <p style="margin-top:20px; font-size:14px;">Аккаунт надоред? <span id="authToggle" style="color:var(--blue); cursor:pointer; font-weight:600;" onclick="toggleAuth()">Сабти ном</span></p>
    </div>
</div>

<div id="appPage" class="app-container hidden">
    <header id="mainHeader">
        <div class="logo">Instagram</div>
        <i class="fa-regular fa-paper-plane" style="font-size:22px; cursor:pointer;" onclick="showPage('chatList')"></i>
    </header>

    <div id="page-feed" class="page active-page"><div id="feed-list"></div></div>

    <div id="page-search" class="page">
        <div class="search-bar"><input type="text" id="searchInput" class="auth-input" placeholder="Ҷустуҷӯи корбарон..." oninput="searchUsers()"></div>
        <div id="search-results"></div>
    </div>

    <div id="page-create" class="page">
        <div style="padding:20px;">
            <h3>Пости нав</h3>
            <input type="file" onchange="previewImg(this, 'pre')" style="margin:20px 0;">
            <img id="pre" style="width:100%; border-radius:8px; display:none; margin-bottom:10px;">
            <textarea id="cap" class="auth-input" placeholder="Тавсифи пост..."></textarea>
            <button class="btn-blue" onclick="uploadPost()">Пост кардан</button>
        </div>
    </div>

    <div id="page-chatList" class="page">
        <header><b>Паёмҳо</b></header>
        <div id="chat-users-list"></div>
    </div>

    <div id="page-direct" class="page">
        <header><i class="fa-solid fa-arrow-left" onclick="showPage('chatList')"></i><b id="chatTitle">User</b><div></div></header>
        <div id="msg-box" class="msg-box"></div>
        <div style="padding:10px; display:flex; gap:10px; border-top:1px solid #eee;">
            <input type="text" id="msgInput" placeholder="Паём..." style="flex:1; padding:10px; border-radius:20px; border:1px solid #ddd; outline:none;">
            <button onclick="sendMsg()" style="color:var(--blue); border:none; background:none; font-weight:bold;">Ok</button>
        </div>
    </div>

    <div id="page-profile" class="page">
        <div style="padding:15px;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <b id="profHeaderName">Username</b>
                <i class="fa-solid fa-right-from-bracket" onclick="logOut()" style="color:red; cursor:pointer;"></i>
            </div>
            <div style="display:flex; align-items:center; gap:25px; margin-top:20px;">
                <img id="myAvatar" src="" class="avatar-sm" style="width:80px; height:80px;">
                <div style="display:flex; flex:1; justify-content:space-around; text-align:center; font-size:14px;">
                    <div><b id="count-p">0</b><br>Пост</div>
                    <div><b id="count-f">0</b><br>Обуначи</div>
                    <div><b id="count-ing">0</b><br>Обуна</div>
                </div>
            </div>
            <div style="margin-top:15px;"><b id="myDisplayName">Name</b></div>
            <button class="btn-blue" style="background:#efefef; color:black; margin-top:15px;" onclick="openEdit()">Редактировать профиль</button>
            <div id="myGrid" style="display:grid; grid-template-columns:repeat(3,1fr); gap:2px; margin-top:20px;"></div>
        </div>
    </div>

    <nav class="nav-bottom">
        <i class="fa-solid fa-house" onclick="showPage('feed')"></i>
        <i class="fa-solid fa-magnifying-glass" onclick="showPage('search')"></i>
        <i class="fa-regular fa-square-plus" onclick="showPage('create')"></i>
        <i class="fa-regular fa-heart"></i>
        <i class="fa-regular fa-user" onclick="showPage('profile')"></i>
    </nav>
</div>

<div class="overlay" id="overlay" onclick="closeEdit()"></div>
<div class="modal" id="editModal">
    <h3>Ислоҳи профил</h3>
    <input type="text" id="newName" class="auth-input" placeholder="Номи нав" style="margin-top:15px;">
    <input type="file" onchange="previewImg(this, 'editPre')">
    <center><img id="editPre" style="width:70px; height:70px; border-radius:50%; margin:10px; display:none; object-fit:cover;"></center>
    <button class="btn-blue" onclick="saveProfile()">Захира</button>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, doc, updateDoc, setDoc, getDoc, where, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // ИНҶО КАЛИДҲОИ ТУ ГУЗОШТА ШУДАНД:
    const firebaseConfig = {
        apiKey: "AIzaSyDc3JvzuiWLbneEUBKzsrEhB5fOCnOFjhc",
        authDomain: "mygram-74b48.firebaseapp.com",
        projectId: "mygram-74b48",
        storageBucket: "mygram-74b48.firebasestorage.app",
        messagingSenderId: "262338393496",
        appId: "1:262338393496:web:469efc8a2bba91cd9127ed",
        measurementId: "G-KQ4HQNP22C"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let isRegMode = false;
    let myData = {};
    let tempImg = "";
    let chatID = "";
    let usersAll = [];

    window.toggleAuth = () => {
        isRegMode = !isRegMode;
        document.getElementById('authToggle').innerText = isRegMode ? "Ворид шудан" : "Сабти ном";
        document.querySelector('.btn-blue').innerText = isRegMode ? "Сабти ном" : "Ворид шудан";
    };

    window.handleAuth = () => {
        const e = document.getElementById('email').value;
        const p = document.getElementById('password').value;
        const action = isRegMode ? createUserWithEmailAndPassword : signInWithEmailAndPassword;
        action(auth, e, p).catch(alert);
    };

    window.logOut = () => signOut(auth);

    onAuthStateChanged(auth, async (user) => {
        if(user) {
            document.getElementById('authPage').classList.add('hidden');
            document.getElementById('appPage').classList.remove('hidden');
            await initUser();
            syncData();
        } else {
            document.getElementById('authPage').classList.remove('hidden');
            document.getElementById('appPage').classList.add('hidden');
        }
    });

    async function initUser() {
        const d = await getDoc(doc(db, "users", auth.currentUser.uid));
        if(!d.exists()) {
            myData = { name: auth.currentUser.email.split('@')[0], pic: 'https://ui-avatars.com/api/?name=User', followers: [], following: [] };
            await setDoc(doc(db, "users", auth.currentUser.uid), myData);
        } else { myData = d.data(); }
        updateProfileUI();
    }

    function updateProfileUI() {
        document.getElementById('profHeaderName').innerText = myData.name;
        document.getElementById('myDisplayName').innerText = myData.name;
        document.getElementById('myAvatar').src = myData.pic;
        document.getElementById('count-f').innerText = myData.followers?.length || 0;
        document.getElementById('count-ing').innerText = myData.following?.length || 0;
    }

    window.openEdit = () => { document.getElementById('overlay').style.display='block'; document.getElementById('editModal').style.display='block'; };
    window.closeEdit = () => { document.getElementById('overlay').style.display='none'; document.getElementById('editModal').style.display='none'; };
    
    window.saveProfile = async () => {
        const up = { name: document.getElementById('newName').value };
        if(tempImg) up.pic = tempImg;
        await updateDoc(doc(db, "users", auth.currentUser.uid), up);
        myData = {...myData, ...up};
        updateProfileUI();
        closeEdit();
    };

    window.searchUsers = () => {
        const val = document.getElementById('searchInput').value.toLowerCase();
        const res = document.getElementById('search-results');
        res.innerHTML = "";
        usersAll.forEach(u => {
            if(u.name.toLowerCase().includes(val) && u.id !== auth.currentUser.uid) {
                const isFollowing = myData.following?.includes(u.id);
                res.innerHTML += `
                <div class="user-row">
                    <div style="display:flex; align-items:center; gap:10px;"><img src="${u.pic}" class="avatar-sm"><b>${u.name}</b></div>
                    <button class="btn-blue" style="width:80px; font-size:12px; background:${isFollowing?'#eee':'var(--blue)'}; color:${isFollowing?'black':'white'}" onclick="follow('${u.id}')">
                        ${isFollowing ? 'Обунаед' : 'Обуна'}
                    </button>
                </div>`;
            }
        });
    };

    window.follow = async (uid) => {
        const isFollowing = myData.following?.includes(uid);
        const myRef = doc(db, "users", auth.currentUser.uid);
        const targetRef = doc(db, "users", uid);

        let newFollowing = isFollowing ? myData.following.filter(id => id !== uid) : [...(myData.following || []), uid];
        await updateDoc(myRef, { following: newFollowing });
        
        const targetDoc = await getDoc(targetRef);
        let targetFollowers = targetDoc.data().followers || [];
        targetFollowers = isFollowing ? targetFollowers.filter(id => id !== auth.currentUser.uid) : [...targetFollowers, auth.currentUser.uid];
        await updateDoc(targetRef, { followers: targetFollowers });

        myData.following = newFollowing;
        updateProfileUI();
        searchUsers();
    };

    window.startChat = (id, name) => { chatID = id; document.getElementById('chatTitle').innerText = name; showPage('direct'); syncMsgs(); };
    window.sendMsg = async () => {
        const t = document.getElementById('msgInput').value;
        if(!t) return;
        await addDoc(collection(db, "messages"), { from: auth.currentUser.uid, to: chatID, text: t, time: Date.now() });
        document.getElementById('msgInput').value = "";
    };

    function syncMsgs() {
        onSnapshot(query(collection(db, "messages"), orderBy("time", "asc")), (snap) => {
            const box = document.getElementById('msg-box');
            box.innerHTML = "";
            snap.forEach(m => {
                const d = m.data();
                if((d.from === auth.currentUser.uid && d.to === chatID) || (d.to === auth.currentUser.uid && d.from === chatID)) {
                    box.innerHTML += `<div class="msg ${d.from === auth.currentUser.uid ? 'sent' : 'rec'}">${d.text}</div>`;
                }
            });
            box.scrollTop = box.scrollHeight;
        });
    }

    window.previewImg = (input, id) => {
        const r = new FileReader();
        r.onload = e => { tempImg = e.target.result; document.getElementById(id).src = e.target.result; document.getElementById(id).style.display='block'; };
        r.readAsDataURL(input.files[0]);
    };

    window.uploadPost = async () => {
        if(!tempImg) return;
        await addDoc(collection(db, "posts"), { img: tempImg, cap: document.getElementById('cap').value, uid: auth.currentUser.uid, user: myData.name, time: Date.now() });
        tempImg = ""; document.getElementById('pre').style.display='none'; showPage('feed');
    };

    function syncData() {
        onSnapshot(collection(db, "users"), (snap) => {
            usersAll = snap.docs.map(d => ({id: d.id, ...d.data()}));
            const cl = document.getElementById('chat-users-list');
            cl.innerHTML = usersAll.filter(u => u.id !== auth.currentUser.uid).map(u => `
                <div class="user-row" onclick="startChat('${u.id}', '${u.name}')">
                    <div style="display:flex; align-items:center; gap:10px;"><img src="${u.pic}" class="avatar-sm"><b>${u.name}</b></div>
                    <i class="fa-regular fa-comment"></i>
                </div>`).join('');
        });

        onSnapshot(query(collection(db, "posts"), orderBy("time", "desc")), (snap) => {
            const fl = document.getElementById('feed-list');
            const gl = document.getElementById('myGrid');
            fl.innerHTML = ""; gl.innerHTML = "";
            let pCount = 0;
            snap.forEach(p => {
                const d = p.data();
                fl.innerHTML += `<div class="post">
                    <div class="post-header"><b>${d.user}</b></div>
                    <img src="${d.img}" class="post-img">
                    <div class="post-btns"><i class="fa-regular fa-heart"></i> <i class="fa-regular fa-comment"></i></div>
                    <div style="padding:0 10px;"><b>${d.user}</b> ${d.cap}</div>
                </div>`;
                if(d.uid === auth.currentUser.uid) {
                    pCount++;
                    gl.innerHTML += `<img src="${d.img}" style="width:100%; aspect-ratio:1/1; object-fit:cover;">`;
                }
            });
            document.getElementById('count-p').innerText = pCount;
        });
    }

    window.showPage = (id) => {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active-page'));
        document.getElementById('page-' + id).classList.add('active-page');
        document.getElementById('mainHeader').style.display = (id === 'feed' || id === 'chatList') ? 'flex' : 'none';
    };
</script>
</body>
</html>